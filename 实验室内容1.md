# 基础知识
1. 电枢控制直流电动机：设R~a~，L~a~分别为电阻和电感，M~c~为电动机轴上的总负载转矩，则
* 电枢回路电压平衡方程：u~a~(t) = L~a~(di~a~(t)/dt) + R~a~i~a~(t) + E~a~，其中E~a~ = C~e~w~m~(t)，C~e~为反电势系数。
* 电磁转矩方程：M~m~(t) = C~m~i~a~(t)，C~m~为转矩系数
* 电动机轴上的转矩平衡方程：J~m~(dw~m~(t)/dt) + f~m~w~m~(t) = M~m~(t) - M~c~(t)

可以得到其微分方程：T~m~(dw~m~(t)/dt) + w~m~(t) = K~m~u~a~(t) - K~c~M~c~(t)，令M~c~ = 0，对上式各项求拉式变换，得(T~m~s + 1)Ω~m~(s) = K~m~U~a~(s)，传递函数G(s) = K~m~/1 + T~m~s

2. 梅森增益公式求解传递函数：P = 1/ΔΣp~k~Δ~k~，其中p~k~为k条前向通路总增益，Δ为1-ΣL~a~-ΣL~b~L~c~...，L~a~为所有单独回路增益和，L~b~L~c~为互不接触的的单独回路中每取两个回路增益相乘

3. 根轨迹：设闭环传递函数为A(s) = C(s)/R(s) = 2K/s^2^+2s+2K，则特征方程式可写为s^2^+2s+2K=0，得s~1~和s~2~，由此可画出根轨迹图，横轴为K，纵轴为虚轴。

4. 李雅普诺夫稳定性：对于一个系统x' = f(x)，如果存在一连续可导且正定的函数V，满足V' < 0，则系统是渐进稳定的（例如V描述系统动能与势能之和）。
对于线性时不变系统x' = Ax，选取V = x^T^Px，其中P对称正定，可证明V'(x)负定。

5. 二次型的求导：例如x^T^Ax，有d(x^T^Ax) = (x^T^A)dx + d(x^T^A)x = x^T^Adx + x^T^d(A^T^x) = x^T^(A+A^T^)dx，当A正定时，原式等于x^T^Adx，对t求导为x^T^Ax'

# 机器人学
## 运动学拾遗
### 雅可比矩阵详解
记p~i~为坐标系i的原点位置向量， q为关节变量向量(关节坐标)，末端执行器的位置，方向随q的变化而变化。q'为关节速度，p~e~'为末端执行器线速度。
文中w~i,i+1~为i+1关于i的角速度^i^w~i+1~，在机器人学习_动力学中有w~i,i+1~ = θ'^i+1^Z~i+1~
p~e~对时间的导数p'~e~可写为：p'~e~ = Σdp~e~/dq~i~ * q'~i~ = Σj~Pi~q'~i~。也有w = ΣJ~α~q'~i~
1. 若关节i为移动型，q~i~ = d~i~，有q'~i~j~Pi~ = d'~i~Z~i-1~，又有平移时^i^~i-1~R = 0，故v~i-1,i~ = d'~i~Z~i-1~，故j~Pi~ = Z~i-1~，j~α~ = 0.
2. 若关节为转动型，同理j~Pi~ = Z~i-1~ X (p~e~ - p~i-1~)，j~α~ = Z~i-1~

上述的Z~i-1~由R第三列给出，p由T的第四列前三个元素给出。J = [j~Pi~ ... j~Pn~, j~Oi~ ... j~On~]，在不同坐标系u中J^u^ = [^u^R 0, 0 ^u^R]

## 动力学详解
### 拉格朗日公式
L = T - U(T,U分别表示总动能/势能)
d/dt*dL/dq'~i~ - dL/dq = ε~i~，其中q为广义坐标，ε为广义力。
举例：L = 1/2IΘ'^2^ + 1/2I~m~k~r~^2^Θ'^2^(前者为转动动能，后面为平动动能)，U = mgl(1 - cosΘ)，则拉格朗日函数为L可知。由拉格朗日方程得(I + I~m~k~r~^2^)Θ'' + mgl(1 - cosΘ) = ε = ┏ - FΘ' - F~m~k~r~^2^Θ'，可得系统的二阶微分方程动力学模型。

### 动能计算
T = Σ(T~li~ + T~mi~)，分别为连杆动能和执行电机动能
T~li~ = 1/2∫p'~i~^*^^T^p'~i~^*^ρdV，其中p~i~^*^表示微元的位置向量。
由r~i~ = p~i~^*^ - p~li~且p~li~ = 1/m∫p~i~^*^ρdV，得p'~i~^*^ = p'~li~ + w~i~ X r~i~，带入原式则得：
* 平动分量：1/2m~li~p'~li~^T^p'~li~
* 旋转分量：1/2w~i~^T^(∫r~i~^^T^r~i~^ρdV)w~i~ = 1/2w~i~^T^I~li~w~i~

又由p'~e~ = Σdp~e~/dq~i~ * q'~i~ = Σj~Pi~q'~i~，带入得T关于J,q'的表达式，再考虑类似的电机动能，化简得T = 1/2q'^T^B(q)q'

### 运动方程
拉格朗日方程可写为：L(q, q') = T(q, q') - U(q)，注意到d/dt(dL/dq'~i~) = d/dt(dT/dq'~i~) = Σb~ij~(q)q~j~'' + Σdb~ij~(q)/dt * q'~j~ = Σb~ij~(q)q''~j~ + ΣΣdb~ij~(q)/dq~k~ * q'~k~q'~j~，dT/dq~i~ = 1/2ΣΣdb~jk~(q)/dq~i~ * q'~k~q'~j~，同理dU/dq~i~ = g~i~(q)

**最终运动方程为**：Σb~ij~(q)q~j~'' + ΣΣh~ijk~(q)q'(k)q'(j) + g~i~(q) = ε~i~

其中b表示惯性力，hq^2^项表示离心力，hq~j~q~k~项表示科氏力，写成矩阵形式：`B(q) + C(q,q')q' + F~v~q' + F~s~sgn(q') + g(q) = ┏ - J^T^(q)h`，其中Fvq'表示粘滞摩擦转矩，f~s~(q,q')为静摩擦转矩，J(q)h为平衡接触力对关节的转矩

### 动力学模型性质
1. B' - 2C反对称性：
由Σc~ij~q'~j~ = ΣΣh~ijk~q'~k~q'~j~ = ΣΣ(db~ij~/dq~k~ - 1/2db~jk~/dq~i~)q'~k~q'~j~ = 1/2ΣΣdb~ij~/dq~k~q'~k~q'~j~ + 1/2ΣΣ(db~ij~/dq~k~ - db~jk~/dq~i~)q'~k~q'~j~，得c~ij~ = Σc~ijk~q'~k~。又b对称，故c对称。
取N(q,,q') = B'(q) - 2C(q,q')，有q'^T^N(q,q')q' = 0。（B'为B对t求导）

2. 动力学参数的线性性:
认为连杆i与转子i+1合在一起为扩展连杆，扩展连杆的动能关于动力学参数是线性的。动力学参数包括质量，惯性一阶矩的三个分量，惯性张量的六个分量，转动惯量。
(m~i~ m~i~l~Cix~ m~i~l~Ciy~ m~i~l~Ciz~ I~ixx~ I~ixy~ I~iyy~ I~xz~ I~yz~ I~zz~ I~m~)，记为Π，将拉格朗日公式改写为：L = Σ(β~Ti~^T^ - β~Ui~^T^)Π~i~。得ε = Σy~ij~Π~i~，其中y~ij~ = d/dt*dβ~Tj~/dq'~i~ - dβ~Ti~/dq~i~ + dβ~Uj~/dq~i~，记Y构成的矩阵为Y，则`┏ = Y(q,q',q'')Π`

### 牛顿欧拉递推法
算法如图：

### 动态标度
无法实现的轨迹需要进行相应的时间尺度定标，需要找到能避免动力学逆解重复计算的自动轨迹动态标度机制，使机械手按正确时间节点实现路径运动。
将C(q,q')q' = T(q)[q'q']，则动力学模型表示为B(q(t))q''(t) + T(q(t))[q'(t)q'(t)] + g(q(t)) = ┏(t)。
令q(t) = q^(r(t))，r为时间缩放函数，则q' = r'q^'(r)，q'' = r'^2^q^''(r) + r''q^'(r)，带入动力学模型，有┏~s~(t) = r'^2^┏^~s~(r) + r''B(q^(r))q^'(r)，其中┏~s~为速度和加速度的转矩分量。

### 动力学可操作椭球
椭球体表示为：(v' + JB^-1^g)^T^J^-T^B^T^J^-1^(v' + JB^-1^g) = 1，二次型的核决定了椭球的主轴和量值，-J^-1^B^-1^g描述了重力作用。

## 执行器与传感器
### 驱动
包括电源，功率放大器，伺服发动机，传动装置。
#### 电气驱动
由基础知识1，得s复数域内电枢的电平衡方程组：V~a~ = (R~a~ + sL~a~)I~a~ + V~g~, V~g~ = k~V~Ω~m~，和力学平衡方程：C~m~ = (sI~m~ + F~m~)Ω~m~ + C~1~，C~m~ = k~t~I~a~，又控制电压和电枢电压之间的输入输出关系可由V~a~/V~c~ = G~V~/1 + sT~V~，G~V~为电压增益。
电气驱动的流程如下：

由于F~m~可以忽略不计，w~m~ ≈ G~V~/k~V~v'~c~，c~m~ ≈ k~t~/k~i~(v'~c~ - k~v~/G~c~w~m~)，则有相似于速度控制发电机的电气驱动：

控制输入和执行器位置输出间的关系用传递函数表示为M(s) = k~m~/s(1+sT~m~)，其中对速度控制发电机有k~m~ = 1/k~v~，T~m~ = R~a~I~m~/k~v~k~t~，对力矩控制发电机有k~m~ = k~t~/k~i~F~m~，T~m~ = I~m~/F~m~

## 运动控制
### 控制理论基础
**状态变量**：一组变量足以完全确定系统运动状态，且个数最小。状态空间是状态变量为坐标轴构成的n维空间。状态方程是状态变量构成的一阶微分方程组。
**Laplace变换**：F(s) = ∫f(t)e^-st^dt。
**传递函数**：零初值线性系统微分方程为a~n~r^n^(t) + a~n-1~r^n-1^(t) + ... +a~0~r(t) = y(t)，方程两端的Laplace变换之比定义为系统的传递函数C(s) = Y(s)/R(s)
**典型环节的传递函数**：
1. 比例环节x~o~(t) = Kx~i~(t)，G(s) = K
2. 积分环节Tdc(t)/dt = r(t)，则G(s) = 1/Ts
3. 微分环节x~o~(t) = Tdx~i~(t)/dt，则G(s) = Ts

**前向/反馈**：前向通道指输入端到输出端的通道，反馈指输出端返送到输入端的信号通道。记输入R(s)，反馈B(s)，前向通道G1(s),G2(s)，输出C(s)，反馈H(s)，则前向传递函数G(s) = C(s)/E(s) = G1(s)G2(s)，反馈传递函数H(s) = B(s)/C(s)，开环传递函数为反馈与误差信号之比，闭环传递函数为输出信号与输入信号之比，记为A(s) = G(s)/1 +- G(s)H(s)



### 关节空间控制
不考虑外部末端执行器作用力和静摩擦情况下：B(q)q'' + C(q,q')q' + F~v~q' + g(q) = ┏，定义n个广义力分量，其实现了q(t) = q~d~(t)，q~d~代表期望关节轨迹变量。

记K~r~为齿轮减速比，有k~ri~q'~i~ = Θ'~mi~。有K~r~q = q~m~，其中q~m~为关节执行元件的位移向量。若┏~m~指执行器驱动转矩向量，有：┏~m~ = K~r~^-1^┏，对于n个驱动系统，有：
* K~t~^-1^┏ = K~t~i~a~
* u~a~ = R~a~i~a~ + K~v~q'~m~
* u~a~ = G~v~u~c~

其中K~t~为转矩常量对角阵，i~a~为n个电动机电枢电流向量，u~a~为电枢电压，R~a~为电枢电路阻抗对角阵，K~v~为n个电动机电压常熟对角阵，G~v~为n个放大器增益对角阵，u~c~为n个伺服电机控制电压向量。

带入得B(q)q'' + C(q,q')q' + Fq' + g(q) = u
其中：
* F = F~v~ + K~r~K~t~R~a~^-1^K~v~K~t~
* u = K~r~K~t~R~a~^-1^G~v~u~c~

故┏ = K~r~KK~t~R~a~^-1^(G~v~u~c~ - K~v~K~r~q')，电压控制驱动系统流程如下：


又┏ = K~r~K~t~i~a~ = K~r~K~t~G~t~v~c~，可知转矩控制驱动系统流程：


### 分散控制
将机械手看作n个独立系统，每个关节轴都是但输入单输出控制系统，运动中位形变化引起的关节间耦合影响视为干扰输入。
由┏~m~ = K~r~^-1^┏，得：K~r~^-1^B(q)K~r~^-1^q''~m~ + K~r~^-1^C(q,q')K~r~^-1^q'~m~ + K~r~^-1^F~v~K~r~^-1^q'~m~ + K~r~^-1^g(q) = ┏~m~。
B(q) = B^ + ΔB(q)，其中B^表示每个关节的平均惯量，则K~r~^-1^B^K~r~^-1^q''~m~  + F~m~q'~m~ + d = ┏~m~，其中：
1. F~m~ = K~r~^-1^F~v~K~r~^-1^为粘滞摩擦系数
2. d为与位形有关的分量

该系统中有两个子系统，一个以┏~m~为输入q~m~为输出，一个以q~m~，q'~m~，q''~m~为输入，d为输出。如下图：


#### 独立关节控制
PI控制的传递函数为C(s) = K~c~(1+sT~c~)/s(K~p~ + K~i~/s中令k~p~ = KT，K~i~ = K)。
对位置，速度，加速度进行内回路反馈如图：

其中C~p~，C~v~，C~A~分别表示位置，速度，加速度控制器，k表示传感器常数，放大增益G~v~。其中D是干扰转矩，通过R~a~/k~t~转化为电压信号。C~A~(s)的输出也是电压。
（只需记住θ''经过T~m~/k~m~或k~TA~后进行了校准，θ'经过1/k~m~或k~TV~后同理，θ经过k~TP~后同理）

**分散前馈控制**：关节控制伺服系统需要高速与高加速度跟踪时采用。系统如下：


### 集中控制
排除非线性耦合项，即对非线性项生成补偿转矩。

#### 重力补偿PD控制
令[q~e~^T^ q'^T^]^T^为系统状态向量，其中q~e~ = q~d~ - q，选定以下正定二次型V(q',q~e~) = 1/2q'^T^B(q)q' + 1/2q~e~^T^K~P~q~e~ > 0，其中K~P~为对称正定阵，第一项表示系统动能，第二项表示系统势能，对时间求导，得：V' = q''^T^B(q)q'' + 1/2q'^T^B'(q)q' - q'^T^K~P~q~e~，求解Bq''，代入得到：V' = 1/2q'^T^(B'(q) - 2C(q,q'))q' - q'^T^Fq' + q'^T^(u - g(q) - K~P~q~e~).
由N = B' - 2C的性质得到右侧第一项为零，第二项负定，所以用u = g(q) + K~P~q~e~表示补偿重力项和比例作用的控制器。
如果引入线性PD控制，u = g(q) + K~P~q~e~ - K~D~q'，则V' = -q'^T^(F + K~D~)q'，其半负定。q'不等于0时V下降q' = 0时V' = 0。
重力补偿PD控制图如下：


#### 逆动力学控制
简化动力学模型为B(q)q'' + n(q,q') = u，将u表示为机械手状态的函数u = B(q)y + n(q,q')，系统可描述为q'' = y，y表示输入向量。机械手控制问题简化为找到稳定控制律y，选y = -K~P~q - K~D~q' + r，得到q'' + K~D~q' + K~P~q = r，假设K~P~，K~D~正定，令其为对角阵K~P~ = diag{w~n1~^2^ ... w~nn~^2^}，K~D~ = diag{2ζ~1~w~n1~ ...2ζ~n~w~nn~}。r~i~只影响关节变量q~i~，由自然频率w~ni~和阻尼比ζ~i~决定。
因此有q''~e~ + K~d~q'~e~ + K~P~q~e~ = 0，得到逆动力学控制方框图：


#### 鲁棒控制
之前的非线性补偿与解耦忽略了动态项，会带来非完全补偿造成的敏感性和鲁棒性问题。
假定不完全补偿下逆动力学控制向量为u = B^(q)y + n^(q,q')，B~e~ = B^ - B表示误差。有Bq'' + n = B^y + n^
因为B可逆，故q'' = y + (B^-1^B^ - I)y + B^-1^n~e~ = y - η。得到q''~e~ + K~D~q'~e~ + K~P~q~e~ = η = y，无法保证误差收敛到零。

考虑q''~e~ = q''~d~ - y + η，令系统状态ζ = [q~e~ q'~e~]，有ζ' = Hζ + D(q''~d~ - y + η)，其中H = [0 I, 0 0]，D=[0 I]，需要找到使η稳定的y的控制律。选择y = q''~e~ + K~D~q'~e~ + K~P~q~e~ + w，得到ζ' = H^ζ + D(η - w)，其中H^ = (H - DK) = [0 I, -K~P~ -K~D~]，w = 0时为精准逆动力学控制器。
选定V(ζ) = ζ^T^Qζ > 0，V' = ζ'^T^Qζ + ζ^T^Qζ' = ζ^T^(H^^T^Q + QH^)ζ + 2ζ^T^QD(η - w)，记H^^T^Q + QH^ = -P，P为对称正定，则变为V' = -ζ^T^Pζ + 2ζ^T^QD(η - w)。
采用控制律w = ρ/||z||*z，得z^T^(η - w) < ||z||(||η|| - ρ)，选取||ρ||≥||η||即可V' < 0。

三种不同分量构成的控制律为：
* B~e~y + n~e~对非线性影响和关节耦合的近似补偿
* q''~d~ + K~D~q'~e~ + K~P~q~e~对线性前馈和线性反馈作用
* w表示计算非线性项中消除不确定量B~e~和n~e~的鲁棒分量。

流程图如下：


#### 自适应控制
动力学逆解计算模型存在参数估计的不确定性，需要设计求解方法使计算模型具有适应性。
考虑控制律u = B(q)q''~r~ + C(q,q')q'~r~ + Fq'~r~ + g(q) + K~D~σ，q'~r~ = q'~d~ + Aq~e~，q''~r~ = q''~d~ + Aq'~e~。其中A正定，σ选取q'~r~ - q' = q'~e~ + Aq~e~。
将控制律带入到动力学方程中，并代入σ，得B(q)σ' + C(q,q')σ + Fσ + K~D~σ = 0。取V(σ,q~e~) = 1/2σ^T^B(q)σ + 1/2q~e~^T^Mq~e~，可以证明V' < 0。
将控制律写为u = Y(q,q',q'~r~,q''~r~)Π^ + K~D~σ，代入运动方程中得到B(q)σ' + C(q,q')σ + Fσ + K~D~σ = -B^~^(q)q''~r~ - C^~^(q,q')q'~r~ - F^~^q'~r~ - g^~^(q) = -Y(q,q',q'~r~,q''~r~)Π~e~，其中Π~e~ = Π^ - Π
用和以前一样的方法选取李雅普诺夫函数V，能够得到参数自适应律Π^' = K~Π~Y^T^(q,q',q'~r~,q''~r~)(q~e~' + Aq~e~)

该控制律有三部分：
* YΠ^描述逆动力学控制
* K~D~σ引入对跟踪误差的PD稳定化线性控制
* Π^由保证渐进补偿。

控制图如下：


### 操作空间控制
关节空间仅能满足自由空间的运动控制，对于末端执行器收到环境约束，操作空间控制较为方便。
控制系统可以合并一些从操作空间到关节空间的变换作用，例如：**逆雅可比控制**和**转置雅可比控制**，如图：

#### 重力补偿PD控制
x^~^ = x~d~ - x~e~，选取V(q',x^~^) = 1/2q'^T^B(q)q' + 1/2x^~^^T^K~P~x^~^ > 0，对时间求导得V' = q'^T^B(q)q'' + 1/2q'^T^B'(q)q' + x^~^'^T^K~P~x^~^，根据x~d~为常值，x'~d~ = 0，有x'^~^ = -J~A~(q)q'，V' = q'^T^B(q)q'' + 1/2q'^T^B'(q)q' - q'^T^J~A~^T^(q)K~P~x^~^ = q'^T^Fq' + q'^T^(u - g(q) - J~A~^T^(q)K~P~x^~^)，选择控制律u = g(q) + J~A~^T^(q)K~P~x^~^ - J~A~^T^(q)K~D~J~A~(q)q'

控制如图：

#### 逆动力学控制
有u = B(q)y + n(q,q')，由x''~e~ = J~A~(q)q'' + J'~A~(q,q')q'可取y = J~A~^-1^(q)(x''~d~ + K~D~x'^~^ + K~P~x^~^ - J~A~'(q,q')q')

控制如图：


# 数值方法
## 非线性方程f(x)=0解法
### x=g(x)迭代法
取起始点p0，p1=g(p0)，p2=g(p1)...若p序列趋向一个极限，则达到目的。称lim(pn) = P，P是不动点。
matlab程序：
```
% tol指容许误差，max1指最大迭代次数
function [k,p,err,P]=fixpt(g,p0,tol,max1)
P(1) = p0;
for k=2:max1
    % feval函数用于调用函数并给其传入参数
    P(k)=feval(g,P(k-1));
    err=abs(P(k)-P(k-1));
    relerr=err/(abs(P(k))+eps);
    p=P(k);
    if (err<tol) | (relerr<tol),break;
end
if k == max1
    disp('maximum number of iterations exceeded')
end
P = P'
```

### 二分法
起始区间[a,b]，第一步选择中点c=(a+b)/2，再分析f(a),f(b)与f(c)符号，选择区间。
二分法的另一种形式式试值法利用割线m=f(b)-f(a)/b-a = 0-f(b)/c-b求得c。

### 牛顿-拉夫森法
g(x) = x - f(x)/f'(x)被称为牛顿-拉夫森迭代函数，迭代p~k~ = g(p~k-1~)收敛到p

## 线性方程求解

# Visual Servo Control
视觉伺服控制利用来自摄像头的视觉反馈来控制机器人的末端执行器对于目标物体的位置和姿态
## 图像处理
**图像解释**：从分割图像中计算特征参数的过程。
特征参数需要计算矩，几何矩为m~i,j~ = ΣI(X~1~,Y~1~)X^i^Y^i^，二值化后假设区域R中所有点光强度等于1，可得m~i,j~ = ΣX~Yi~，即为区域面积。可用像素总数计算。
x^ = m~1,0~/m~0,0~, y^ = m~0,1~/m~0,0~定义区域的形心，用于检测R在图像上的位置。中心矩定义为μ = Σ(X~1~ - x^) ^i^ (Y~1~ - y^) ^j^，矩阵I = [μ~2,0~ μ~1,1~, μ~1,1~ μ~0,2~]具有相对质心的惯性张量的含义。矩阵I的特征值定义了主惯性矩，特征向量定义了主轴。α = 1/2arctan(2μ~1,1~/μ~2,0~ - μ~0,2~)。

## 位姿估计
**归一化坐标**：记相机坐标系O~c~-x~c~y~c~z~c~，在成像平面引入坐标系，记原点到透镜中心距离f，则X~f~ = -fp~x~/p~z~，y~f~ = -fp~y~/p~z~。
进一步对于像素坐标系，有X~1~ = α~x~fp~x~/p~z~ + X~0~，Y~1~ = α~y~fp~y~/p~z~ + Y~0~，可写为[x y λ] = λ[X Y 1] = ΩΠ[p~x~ p~y~ p~z~ 1]，其中Ω = [fα~x~ 0 X~0~, 0 fα~y~ Y~0~, 0 0 1]，记[X, Y]为归一化坐标。

### 解析解
设相机参考坐标系O~c~，物体坐标系O~o~，T~o~^c^为目标位姿相对于相机的齐次变换矩阵，设有n个点，r~o,i~^o^ = p~i~^o^ - o~o~^o^，记这些点在图像平面的坐标为s~i~ = [X~i~ Y~i~]，特征向量s = [s1 ... sn]，有λ~i~s~i~ = ΠT~o~^c^r~o,i~^o^，上述n个方程可求解矩阵T中未知元素，称为PnP问题。
对两侧乘以斜对称矩阵s^，左侧为零(s^*s = sXs)，得到s^~i~H[r~x,i~ r~y,i~ 1]^T^ = 0，H为3x3矩阵[r1 r2 o~c,o~^c^]，r1和r2是旋转矩阵的第一，第二列。也可写为A~i~(s~i~)h = 0，其中A~i~(s~i~)为3x9维矩阵，h是9x1维向量。

对A奇异值分解得到V，由V的最后一列得到非零解γh = 0，γ = 1/||h1||（这里的h1是γH的第一列），进而解得r1, r2, r3 = r1 X r2。由于噪音，Q = [r1 r2 r3]并不一定是旋转矩阵，通过计算最接近Q的旋转矩阵：||R~o~^c^ - Q||~F~ = (Tr((R~0~^c^ - Q)^T^(R~o~^c^ - Q)))^1/2^，令范数最小化。其等价于令R~o~^c^^T^Q的迹最大化。得到R~o~^c^ = U[1 0 0, 0 1 0, 0 0 δ]V^T^，U和V分别是Q = UΣV^T^的左正交和右正交矩阵。

### 相互作用矩阵
若目标相对于相机运动，特征向量s是时变的，可能要在图像平面定义速度向量s'。

记目标相对相机速度v~c,o~^c^ = [o'~c,o~^c^ R~c~^T^(w~o~ - w~c~)]，s' = J~s~(s,T~o~^c^)v~c,o~^c^。J~s~称为图像雅可比矩阵。

记相机绝对速度v~c~ = [R~c~^T^o'~c~ R~c~^T^w~c~]，目标绝对速度同理，向量o'~c,o~^c^ = R~c~^T^(o'~o~ - o'~c~) + (o~c,o~^c^)^ R~c~^T^w~c~（法向和切向速度）。则v~c,o~^c^ = v~o~^c^ + ┏(o~c,o~^c^)v~c~^c^，其中┏(*) = [-I S( * ), 0 -I]。

因此，s' = J~s~v~o~^c^ + L~s~v~c~^c^，其中L~s~ = J~s~(s,T~o~^c^)┏(o~c,o~^c^)为交互矩阵

**点的交互矩阵**：r~c~^c^ = R~c~^T^(p - o~c~)，选择标准化坐标的向量s = s(r~c~^c^) = 1/z~c~[x~c~ y~c~] = [X Y]，对s求导，s' = ds(r~c~^c^)/dr~c~^c^*r'~c~^c^，进而可求得交互矩阵和雅可比矩阵。
对于线段，特征向量可定为[x^ y^ L α]，求解同理

### 算法解
交互矩阵L~s~为维数kxm的矩阵，k为图像特征参数数量，m为速度向量v的维数，J~s~与雅可比矩阵秩相同。
* 当k=m时，v~c,o~^c^ = ┏(o~c,o~^c^)L~s~^-1^s'
* 当k>m时，最小二乘法得v~c,o~^c^ = ┏(o~c,o~^c^)(L~s~^T^L~s~)L~s~^T^s'
* 当k<m时，方程具有无穷多解，图像参数不足。

**位姿估计**：记位姿为x~c,o~，v~c,o~^c^ = [I 0 0 T(θ~c,o~)]x'~c,o~ = T~A~(θ~c,o~)x'~c,o~，也即s' = J~A~(s,x~c,o~)x'~c,o~，其中J~A~(s,x~c,o~) = L~s~┏(-o~c,o~^o^)T~A~(θ~c,o~)。

令x^ 表示x的估计量，s^ = s(x^~c,o~)为图像特征参数的相应向量，算法目标是使e = s - s^最小。对e求导，得到e' + K~s~e = 0的等价线性系统。姿态估计算法如图：


## 立体视觉
解决匹配问题，对场景中同一点在两幅图像上的投影点的识别，这些点称为配对点。同时进行3D重构

### 核面几何
假设两台相机，各自为坐标系1和坐标系2，则p^1^ = o~1,2~^1^ + R~2~^1^p^2^，令s~1~和s~2~为P点在相机图像平面上投影的坐标，λ~i~s~i~ = p^i^。带入得λ~1~s~1~ = o~1,2~^1^ + λ~2~R~2~^1^s~2~ ，两边左乘s~1~^T^o^ ~1,2~^1^，得：
λ~2~s~1~^T^o^~1,2~ ^1^R~2~^1^s~2~ = 0
其等价于核面约束s~1~^T^Es~2~ = 0，E为本质矩阵(3x3)表示了相同点投影之间的几何约束。
极面几何关系如图：

应用极面约束降低问题复杂性，只需搜索沿极线上的点。

### 三角测量
设已知相机内外参数，计算投射在两个图像平面上的点在场景中的位置，设投影坐标分别为s~1~=[X~1~,Y~1~]，s~2~=[X~2~,Y~2~]，假设基坐标与1重合，根据p = λ~1~s~ 和p = o + λ~2~Rs~2~得：
* [1 0 -X~1~, 0 1 -Y~1~]p = 0
* [r~1~^T^ - X~2~r~3~^T^, r~2~^T^ - Y~2~r~3~^T^]p = [o~x~ - o~z~X~2~, o~y~ - o~z~Y~2~]

第二个式子是左乘R得到，R = [r1, r2, r3]，R^T^o = [o~x~, o~y~, o~z~]，上述式子忽略了系数λ~1~和λ~2~。

在日常应用中常有两相机平行，R = I，R^T^o = [b 0 0]，得：
* px = X~1~b/X~1~ - X~2~
* py = Y~1~b/X~1~ - X~2~
* pz = b/X~1~ - X~2~

### 绝对定向
由于系统相对相机运动，可用三角测量法计算目标姿态的变化。
若相机系统移动，目标固定，设p~1~...p~n~表示被测物体上的n个点在时刻t得向量，p~1~' ... p~n~'表示t'时刻的向量，有p~i~ = o + Rp~i~'，绝对定向问题计算o和R。
考虑令如下二次型Σ||p~i~ - o - Rp~i~'||^2^最小，得o = p^ - Rp^'，p^代表矩心。带入得令方程极小的矩阵R即为令R^T^K的迹极小的矩阵R，其中K = Σp^~i~ p^ ~i~'^T^

### 平面单应性3D重建
对于坐标系2，令p^2^为目标上一点P的位置向量，n^2^表示正交于特征点平面的单位向量，平面到坐标系2原点距离d~2~，则: 1/d~2~n^2T^p^2^ = 1。
又p^1^ = Hp^2^，H = R~2~^1^ + 1/d~2~o~1,2~^1^n^2T^。s~1~ = λHs~2~，左乘s^~1~得s^~1~Hs~2~ = 0。由与PnP问题相似的处理可得到γH，求得γ进而得到H，进而求得R，1/d~2~o，n^2T^等。

## 相机标定
标定包括内参数估计与外参数估计，内参数由矩阵Ω定义，外参数为相机坐标系相对基坐标系（眼到手）或末端执行器的位姿（眼在手）。
对于眼到手，外参数T~c~^b^ = T~o~^b^(T~o~^c^)^-1^，T~o~^c^由PnP问题解出
对于眼在手，T~c~^e^ = T~0~^e^(T~o~^c^)^-1^
流程：
1. 计算平面单应性关系，根据像素坐标得c~i~ = [X~li~ Y~li~]，类似归一化坐标得到H'，有H' = ΩH。
2. 由γ[h'~1~ h'~2~ h'~3~] = Ω[r~1~ r~2~ o~c,o~^c^]得到，故r~1~ = Ω^-1^h~1~，r~2~ = Ω^-1^h~2~，由r1，r2正交得到h~1~^T^Ω^-T^Ω^-1^h~2~ = 0和h~1~^T^Ω^-T^Ω^-1^h~1~ = h~2~^T^Ω^-T^Ω^-1^h~2~。
设B = Ω^-T^Ω^-1^，则参考[专栏推导](https://zhuanlan.zhihu.com/p/87334006)，能得到A'b = 0，解得γb后根据B矩阵的形式得到内参。
3. 估计得到Ω后即可由H'计算得到H和γ，再得到T~o~^c^，最后估计外参数。

## 视觉伺服问题
控制方式分为基于位置和图像的控制，方案如下：

### 基于位置
定义操作空间的误差向量：x = -[o~d,c~^d^ θ~d,c~]
**重力补偿PD控制**：
对位置误差部分求导o'~d,c~^d^ = o'~c~^d^ - o'~d~^d^ = R~d~^T^o'~c~，对方向部分θ'~d,c~ = T^-1^(θ~d,c~)w~d,c~^d^ = T^-1^(θ~d,c~)R~d~^T^w~c~。因此x' = -T~A~^-1^(θ~d,c~)[R~d~^T^ o, o R~d~^T^]v~c~ = -J~A~(q,x)q'，其中J~A~(q,x) = T~A~^-1^(θ~d,c~)[R~d~^T^ o, o R~d~^T^]J(q).
基于位置的视觉伺服重力补偿PD表达式为：
* u = g(q) + J~A~^T^(q,x)(K~p~x - K~D~J~A~(q,x)q)

系统方框图如下：

**速度分解控制**：
若机械手在关节空间或操作空间配备了高增益运动控制器，则被控机械手可视为理想的位置装置，有q(t) ≈ q~r~(t)，q'~r~ = J~A~^-1^(q~r~,x)Kx，得线性方程x' + Kx = 0，上式表示操作空间误差收敛速度取决于K的特征值，越大收敛越快

### 基于图像
s~d~ = s(x~d,o~)，考虑图像空间误差e~s~ = s~d~ - s趋于零。
**重力补偿PD控制**：
取V(q',e~s~) = 1/2q'^T^B(q)q + 1/2e~s~^T^K~Ps~e~s~，根据之前类似的推导得u = g(q) = J~L~^T^(s,z~c~,q)(K~Ps~e~s~ - K~Ds~J~L~(s,z~c~,q)q')，
流程图如下：


**速度分解控制**：
s'~d~ = 0，e'~s~ = -s' = -J~L~(s,z~c~,q)q'，J~L~可理解为J~s~*J(q)。
选择关节空间参考速度q'~r~ = J~L~^-1^(s,z~c~,q~r~)K~s~e~s~，得e'~s~ + K~s~e = 0，方程渐进稳定。
流程图如下：
